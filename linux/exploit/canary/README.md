# Canary example

- Compile with -fstack-protector-all.
```
# part of a_canary.S
0000000000400534 <main>:
#include <string.h>

int main(int argc, char **argv)
{
  400534:       a9bd7bfd        stp     x29, x30, [sp, #-48]!
  400538:       910003fd        mov     x29, sp
  40053c:       b9001fa0        str     w0, [x29, #28]
  400540:       f9000ba1        str     x1, [x29, #16]
  400544:       d0000460        adrp    x0, 48e000 <__FRAME_END__+0xfee0>
  400548:       91398000        add     x0, x0, #0xe60
  40054c:       f9400001        ldr     x1, [x0]
  400550:       f90017a1        str     x1, [x29, #40]
  400554:       d2800001        mov     x1, #0x0                        // #0
        char a[] = "hello";
  400558:       f00002e0        adrp    x0, 45f000 <do_release_all+0x10>
  40055c:       91232001        add     x1, x0, #0x8c8
  400560:       910083a0        add     x0, x29, #0x20
  400564:       b9400022        ldr     w2, [x1]
  400568:       b9000002        str     w2, [x0]
  40056c:       b8402021        ldur    w1, [x1, #2]
  400570:       b8002001        stur    w1, [x0, #2]

        strcpy(a, argv[1]);
  400574:       f9400ba0        ldr     x0, [x29, #16]
  400578:       91002000        add     x0, x0, #0x8
  40057c:       f9400001        ldr     x1, [x0]
  400580:       910083a0        add     x0, x29, #0x20
  400584:       94004e8f        bl      413fc0 <strcpy>

        return 0;
  400588:       52800000        mov     w0, #0x0                        // #0
}
  40058c:       d0000461        adrp    x1, 48e000 <__FRAME_END__+0xfee0>
  400590:       91398021        add     x1, x1, #0xe60
  400594:       f94017a2        ldr     x2, [x29, #40]
  400598:       f9400021        ldr     x1, [x1]
  40059c:       ca010041        eor     x1, x2, x1
  4005a0:       f100003f        cmp     x1, #0x0
  4005a4:       54000040        b.eq    4005ac <main+0x78>  // b.none
  4005a8:       94005fca        bl      4184d0 <__stack_chk_fail>
  4005ac:       a8c37bfd        ldp     x29, x30, [sp], #48
  4005b0:       d65f03c0        ret
  4005b4:       00000000        .inst   0x00000000 ; undefined

```

- Compile without -fstack-protector-all.
```
# part of a_no_canary.S
0000000000400534 <main>:
  400534:       a9bd7bfd        stp     x29, x30, [sp, #-48]!
  400538:       910003fd        mov     x29, sp
  40053c:       b9001fa0        str     w0, [x29, #28]
  400540:       f9000ba1        str     x1, [x29, #16]
  400544:       f00002e0        adrp    x0, 45f000 <free_category+0x70>
  400548:       91202001        add     x1, x0, #0x808
  40054c:       9100a3a0        add     x0, x29, #0x28 
  400550:       b9400022        ldr     w2, [x1]
  400554:       b9000002        str     w2, [x0]
  400558:       b8402021        ldur    w1, [x1, #2]
  40055c:       b8002001        stur    w1, [x0, #2]
  400560:       f9400ba0        ldr     x0, [x29, #16]
  400564:       91002000        add     x0, x0, #0x8
  400568:       f9400001        ldr     x1, [x0]
  40056c:       9100a3a0        add     x0, x29, #0x28 
  400570:       94004e84        bl      413f80 <strcpy>
  400574:       52800000        mov     w0, #0x0                        // #0
  400578:       a8c37bfd        ldp     x29, x30, [sp], #48
  40057c:       d65f03c0        ret   
```

- We notice the difference between these two part is that there is `__stack_chk_fail` in the end of `a_canary.S`.
```
  40058c:       d0000461        adrp    x1, 48e000 <__FRAME_END__+0xfee0>
  400590:       91398021        add     x1, x1, #0xe60
  400594:       f94017a2        ldr     x2, [x29, #40]
  400598:       f9400021        ldr     x1, [x1]
  40059c:       ca010041        eor     x1, x2, x1
  4005a0:       f100003f        cmp     x1, #0x0
  4005a4:       54000040        b.eq    4005ac <main+0x78>  // b.none
  4005a8:       94005fca        bl      4184d0 <__stack_chk_fail>
```

- Then we get the canary address `[x29, #40]` which means `$(x29+40)`
```
  400594:       f94017a2        ldr     x2, [x29, #40]
```

- Finally we only use gdb watch this address.
```
$ gdb watch $(x29+40)
```
